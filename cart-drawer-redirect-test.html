<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart Drawer Auto-Open Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .test-section { 
            background: white; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 4px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>🛒 Cart Drawer Auto-Open Test</h1>
    
    <div class="test-section">
        <h2>🔍 Debug Information</h2>
        <p>This page will test if the cart drawer auto-open functionality is working properly.</p>
        <p><strong>Issue:</strong> Adding items to cart redirects to <code>/cart</code> page instead of opening drawer.</p>
    </div>
    
    <div class="test-section">
        <h2>🧪 Tests</h2>
        <button onclick="testCartDrawerExists()">1. Test Cart Drawer Exists</button>
        <button onclick="testCustomElementRegistered()">2. Test Custom Element Registered</button>
        <button onclick="testAutoOpenSetting()">3. Test Auto-Open Setting</button>
        <button onclick="testEventDispatch()">4. Test Event Dispatch</button>
        <button onclick="testManualOpen()">5. Test Manual Open</button>
        <button onclick="clearResults()">Clear Results</button>
        
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>📋 Simulated Product Form</h2>
        <p>This simulates adding a product to cart:</p>
        <form id="test-product-form">
            <input type="hidden" name="id" value="12345">
            <input type="hidden" name="quantity" value="1">
            <button type="submit">Add to Cart (Test)</button>
        </form>
    </div>
    
    <div class="test-section">
        <h2>📊 Console Output</h2>
        <p>Check the browser console (F12) for detailed logging. You should see:</p>
        <ul>
            <li>🚀 Cart drawer JavaScript loaded!</li>
            <li>🛒 Cart drawer connected!</li>
            <li>🎯 Cart update event detected</li>
            <li>Auto-opening cart drawer</li>
        </ul>
    </div>

    <!-- Include minimal cart drawer for testing -->
    <cart-drawer class="cart-drawer" data-auto-open="true" style="display: none;">
        <dialog ref="dialog" id="test-cart-drawer">
            <div style="background: white; border: 2px solid #007bff; padding: 20px; border-radius: 8px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999;">
                <h3>🛒 Test Cart Drawer</h3>
                <p>This is a test cart drawer!</p>
                <p>If you see this, the cart drawer opened successfully.</p>
                <button onclick="closeTestDrawer()">Close</button>
            </div>
        </dialog>
    </cart-drawer>

    <script>
        // Test functions
        function addResult(message, type = 'success') {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            results.appendChild(div);
            console.log(message);
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            console.clear();
        }
        
        function testCartDrawerExists() {
            const drawer = document.querySelector('cart-drawer');
            if (drawer) {
                addResult('✅ Cart drawer element found', 'success');
            } else {
                addResult('❌ Cart drawer element not found', 'error');
            }
        }
        
        function testCustomElementRegistered() {
            const registered = customElements.get('cart-drawer');
            if (registered) {
                addResult('✅ cart-drawer custom element registered', 'success');
            } else {
                addResult('❌ cart-drawer custom element not registered', 'error');
            }
        }
        
        function testAutoOpenSetting() {
            const drawer = document.querySelector('cart-drawer');
            if (drawer) {
                const setting = drawer.getAttribute('data-auto-open');
                addResult(`Auto-open setting: ${setting}`, setting === 'true' ? 'success' : 'warning');
            } else {
                addResult('❌ Cannot test auto-open setting - drawer not found', 'error');
            }
        }
        
        function testEventDispatch() {
            console.log('🧪 Testing event dispatch...');
            
            // Listen for the event
            const listener = (event) => {
                console.log('🎉 Cart update event received!', event.detail);
                addResult('✅ Cart update event successfully dispatched and received', 'success');
                document.removeEventListener('cart:update', listener);
            };
            
            document.addEventListener('cart:update', listener);
            
            // Dispatch a test event
            const testEvent = new CustomEvent('cart:update', {
                detail: {
                    data: {
                        source: 'product-form-component',
                        itemCount: 1,
                        productId: '12345'
                    }
                }
            });
            
            setTimeout(() => {
                document.dispatchEvent(testEvent);
                addResult('🔄 Test cart update event dispatched', 'success');
            }, 100);
        }
        
        function testManualOpen() {
            const drawer = document.querySelector('cart-drawer');
            if (drawer && drawer.showDialog) {
                drawer.showDialog();
                addResult('✅ Manual showDialog() called', 'success');
            } else if (drawer) {
                // Fallback - try to open the dialog directly
                const dialog = drawer.querySelector('dialog');
                if (dialog) {
                    dialog.showModal();
                    addResult('✅ Manual dialog.showModal() called', 'success');
                } else {
                    addResult('❌ Dialog element not found', 'error');
                }
            } else {
                addResult('❌ Cart drawer not found or showDialog method not available', 'error');
            }
        }
        
        function closeTestDrawer() {
            const dialog = document.getElementById('test-cart-drawer');
            if (dialog) {
                dialog.close();
            }
        }
        
        // Simulate product form submission
        document.getElementById('test-product-form').addEventListener('submit', function(event) {
            event.preventDefault();
            console.log('🛍️ Simulating product form submission...');
            
            // Simulate the CartAddEvent that product-form.js would dispatch
            const cartEvent = new CustomEvent('cart:update', {
                detail: {
                    data: {
                        source: 'product-form-component',
                        itemCount: 1,
                        productId: '12345'
                    }
                }
            });
            
            addResult('🔄 Simulating add-to-cart event...', 'warning');
            
            setTimeout(() => {
                document.dispatchEvent(cartEvent);
                addResult('✅ CartAddEvent dispatched!', 'success');
            }, 500);
        });
        
        // Listen for cart events globally
        document.addEventListener('cart:update', function(event) {
            console.log('🎯 Global cart update listener triggered:', event.detail);
            addResult('🎉 Global cart update event detected', 'success');
            
            // Check if this should trigger auto-open
            const drawer = document.querySelector('cart-drawer');
            const autoOpen = drawer?.getAttribute('data-auto-open') === 'true';
            const isFromProductForm = event.detail?.data?.source === 'product-form-component';
            
            if (autoOpen && isFromProductForm) {
                addResult('🎯 Auto-open conditions met - should open drawer', 'success');
                testManualOpen(); // Simulate opening
            } else {
                addResult(`⚠️ Auto-open conditions not met: autoOpen=${autoOpen}, isFromProductForm=${isFromProductForm}`, 'warning');
            }
        });
        
        // Initial logging
        console.log('🌟 Cart drawer test page loaded');
        console.log('🕒 Timestamp:', new Date().toISOString());
        console.log('🔍 Testing cart drawer auto-open functionality');
        
        // Run initial tests
        setTimeout(() => {
            testCartDrawerExists();
            testCustomElementRegistered();
            testAutoOpenSetting();
        }, 100);
    </script>
</body>
</html>
